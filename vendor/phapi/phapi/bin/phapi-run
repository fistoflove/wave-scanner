#!/usr/bin/env php
<?php

/**
 * PHAPI Runner - Wrapper that ensures Swoole is loaded
 * 
 * Usage:
 *   ./bin/phapi-run app.php
 *   php bin/phapi-run app.php
 */

if (php_sapi_name() !== 'cli') {
    exit('This script can only be run from command line.');
}

$autoloadPaths = [
    getcwd() . '/vendor/autoload.php',
    __DIR__ . '/../../../autoload.php',
    __DIR__ . '/../vendor/autoload.php',
];

$autoloadLoaded = false;
foreach ($autoloadPaths as $autoloadPath) {
    if (file_exists($autoloadPath)) {
        require $autoloadPath;
        $autoloadLoaded = true;
        break;
    }
}

if (!$autoloadLoaded) {
    fwrite(STDERR, "Error: Composer autoload not found.\n");
    exit(1);
}

$runtime = getenv('APP_RUNTIME') ?: 'swoole';

if ($runtime === 'portable_swoole') {
    if (!extension_loaded('swoole')) {
        $extPath = \PHAPI\Runtime\PortableSwooleLoader::resolveExtensionPathFromConfig();
        if ($extPath && file_exists($extPath)) {
            $args = array_slice($argv, 1);
            $script = $args[0] ?? 'app.php';
            $escapedArgs = array_map('escapeshellarg', $args);
            $command = 'PHAPI_PORTABLE_SWOOLE_USED=1 ' . escapeshellarg(PHP_BINARY) . ' -d ' . escapeshellarg('extension=' . $extPath) . ' ' . implode(' ', $escapedArgs);
            passthru($command, $status);
            exit($status);
        }
        if (!\PHAPI\Runtime\PortableSwooleLoader::load()) {
            echo "Error: Portable Swoole runtime requested but Swoole could not be loaded.\n";
            echo "Set PHAPI_PORTABLE_SWOOLE_DIR or PHAPI_PORTABLE_SWOOLE_EXT, run via bin/phapi-run, or use -d extension=/path/to/swoole.so.\n";
            exit(1);
        }
    }
} elseif (!extension_loaded('swoole')) {
    echo "Error: Swoole extension is not loaded.\n";
    echo "Please install the native Swoole PHP extension.\n";
    exit(1);
}

// Swoole is loaded, run the script
$script = $argv[1] ?? 'app.php';
if (!file_exists($script)) {
    echo "Error: Script '$script' not found.\n";
    exit(1);
}

require $script;
